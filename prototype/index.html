<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Study Tool Prototype</title>
	<script src="webgazer.js" type="text/javascript"></script>
	<link rel='stylesheet' type='text/css' href='reset.css'>
	<link rel='stylesheet' type='text/css' href='index.css'>
</head>
<body>
	<main class='content'>
		<div id='instructions'>
			<h1>
				Prototype Eye Tracker
			</h1>
			<h4>
				How to calibrate:
			</h4>
			<p>
				Click the buttons in the four corners until they disappear.
			</p>
		</div>
		<p id='xval'>
		</p>
		<button class='button-calibrate' id='cal-1' onclick="calib(1)">
			5
		</button>
		<button class='button-calibrate' id='cal-2' onclick="calib(2)">
			5
		</button>
		<button class='button-calibrate' id='cal-3' onclick="calib(3)">
			5
		</button>
		<button class='button-calibrate' id='cal-4' onclick="calib(4)">
			5
		</button>
		<div id='garden' class='garden'>
			YERRRR
		</div>
		<div id="focus">
			
		</div>
	</main>
</body>
<script>
	var clickCount = 0;
	var calibrated = false;

	function calib(n){
		var newVal = document.getElementById("cal-" + n).innerHTML - 1;
		document.getElementById("cal-" + n).innerHTML = newVal;
		if(newVal === 0){
			document.getElementById("cal-" + n).style.display = "none";
		}
		clickCount = clickCount + 1;
		if(clickCount === 15){
			calibrated = true;
			document.getElementById("garden").style.display = "block";
			document.getElementById("instructions").style.display = "none";
		}

	}
	const width = window.innerWidth;
	const height = window.innerHeight;
	webgazer.begin();

	var xAvg = width / 2;
	var yAvg = height / 2;
	document.getElementById("xval").innerHTML = xAvg;

	var unfocusedTime = 0;
	var distractedTime = 0;

	const intervalWebgazer = setInterval(function(){
		var prediction = webgazer.getCurrentPrediction();
		if(prediction && calibrated){
			if(prediction.x > width / 2){
				//looking at right side of screen
			}
			else{
				//left side of screen
			}
			//if the user is gazing at the same area
			if(Math.abs(xAvg - prediction.x) < width / 3 && Math.abs(yAvg - prediction.y) < height / 3){
				xAvg = (xAvg * .9) + (prediction.x * .1);
				yAvg = (yAvg * .9) + (prediction.y * .1);
				unfocusedTime = unfocusedTime + 1;
			}
			else{
				xAvg = (xAvg * .6) + (prediction.x * .4);
				yAvg = (yAvg * .6) + (prediction.y * .4);	
				unfocusedTime = 0;
			}
			if(unfocusedTime > 30){
				window.alert("You seem to be losing concentration. Why not take a break and come back?");
				unfocusedTime = 0;
			}
			console.log(xAvg);
			console.log(yAvg);
			document.getElementById("xval").innerHTML = xAvg;
			document.getElementById("focus").style.top = (yAvg + "px");
			document.getElementById("focus").style.left = (xAvg + "px");
		}
		else if(calibrated){
			if(distractedTime > 20){
				window.alert("distracted");
			}
		}
	}, 100);


</script>
</html>